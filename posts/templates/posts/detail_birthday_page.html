{% extends 'posts/base.html' %}
{% block content %}
  {% load static%}
  <head>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/detail_birthday_page.css' %}" />
  </head>
  <body>
    <div class="content" id="screenshot">
        <div>
          <!--아카이브 상태 표시-->
          {% if photo_page.state == "archive" %}
            <div class="archive">
              {% if is_owner %}
                <p>
                  {{name}}님의 {{year}}년 생일 페이지입니다.
                </p>
              {% else %}
                <p>
                  {{name}}님의 생일이 지나서 메시지를 남길 수 없어요. 내년에도 축하해주실거죠?
                </p>
              {%endif%}
            </div>
          {%endif%}

          {% if birthday_page.state == "waiting"%}
            <div class="text--waiting">
              <div class="text--waiting__title">
                <div class="text--waiting__title__line">
                  <h1 class="text--waiting__title--highlight">{{name}}</h1>
                  <h1>님의 생일까지</br></h1>
                </div>
                <div class="text--waiting__title__line">
                  <h1 class="highlight">{{date_diff}}</h1>
                  <h1>일 남았어요!</h1>
                </div>
              </div>
              
              <p class="text--waiting__description">
                생일 페이지는</br>생일 7일 전 부터 개설돼요.</br>조금만 기다려 주세요!
              </p>
            </div>
          {% else %}
            <!-- 디데이 -->
            <div class="text--activate">
              <span class="text--activate__date-diff">
              {% if birthday_page.state == "today" %}
                <h6 class="highlight">오늘 생일</h6>
              {% else %}
                <h6>생일까지</h6>
                <div class="text--activate__date-diff__line">
                  <h6 class="highlight">D-{{ date_diff }}</h6>
                  <h6>일</h6>
                </div>
              {% endif %}
              </span>
              <!-- 스크린샷 버튼 -->
              {% if birthday_page.state != "waiting" and is_owner %}
                <div>
                  <button onclick="screenshot()" type="button" id="save">페이지 저장하기</button>
                </div>
              {% endif %}
              
            </div>
            <div class="image--activate">
              <!-- 케이크 -->
              {% if messages.count >= 0 %}
                  {% if target == "초코" %}
                    {% if messages.count <= 5 %}
                    <img src="{% static 'img\cake\cake-choco-01.png' %}">
                    {% elif messages.count <= 10 %}
                    <img src="{% static 'img\cake\cake-choco-02.png' %}">
                    {% elif messages.count <= 15 %}
                    <img src="{% static 'img\cake\cake-choco-03.png' %}">
                    {% elif messages.count <= 20 %}
                    <img src="{% static 'img\cake\cake-choco-04.png' %}">
                    {% endif %}
                  {% elif target == "딸기"%}
                    {% if messages.count <= 5 %}
                    <img src="{% static 'img\cake\cake-strawberry-01.png' %}">
                    {% elif messages.count <= 10 %}
                    <img src="{% static 'img\cake\cake-strawberry-02.png' %}">
                    {% elif messages.count <= 15 %}
                    <img src="{% static 'img\cake\cake-strawberry-03.png' %}">
                    {% elif messages.count <= 20 %}
                    <img src="{% static 'img\cake\cake-strawberry-04.png' %}">
                    {% endif %}
                  {% elif target == "치즈"%}
                    {% if messages.count <= 5 %}
                    <img src="{% static 'img\cake\cake-carrot-01.png' %}">
                    {% elif messages.count <= 10 %}
                    <img src="{% static 'img\cake\cake-carrot-02.png' %}">
                    {% elif messages.count <= 15 %}
                    <img src="{% static 'img\cake\cake-carrot-03.png' %}">
                    {% elif messages.count <= 20 %}
                    <img src="{% static 'img\cake\cake-carrot-04.png' %}">
                    {% endif %}
                  {% endif %}
              {% endif %}
            </div>

            <div class="text-main--activate">
              <p>{{ name }}님, 생일 축하드려요!</p>
            </div>

            <!-- 메시지 -->
            <div class="messages">
              <img class="messages__wave-pattern" src="{% static 'img\wave-pattern.svg' %}">
              <div class="messages__content">
                {% if messages %}
                <!--
                {% if birthday_page.state == "archive"%}
                  <span> {{name}} 님의 지난 생일을 축하했던 메시지들이에요!<span>
                {% else %}
                  <span>{{name}}님의 생일을 축하하는 메시지가 도착했어요!</span>
                {% endif %}
                -->
                <ul>
                  {% for message in messages  %}
                    <li>
                      <!-- 메시지가 공개일 경우 모두에게 보여준다. -->
                      {% if not message.is_private %}
                      <div class="messages__content__message">
                        <img class="message__profile" src="{{ message.profile_img }}" alt="">
                        <div class="message__message">
                          <h6 class="message__nickname">{{ message.nickname }}</h6>
                          <h6 class="message__message">{{ message.message }}</h6>
                        </div>
                      </div>
                        <!-- 삭제 버튼 -->
                      <div class="messages__delete-btn">
                        {% if is_owner or request.user == message.sender %}
                        <a href="{% url 'posts:delete_message' message.id %}" data-html2canvas-ignore="true">삭제</a>
                        {% endif %}
                      </div>
                      <!-- 메시지가 비공개일 경우 메시지를 쓴 사람과 owner에게만 보여준다. -->
                        {% else %}
                        {% if is_owner or request.user == message.sender %}
                          <img src="{{ message.profile_img }}" alt="">
                          {{ message.nickname }} : {{ message.message }}
                          <a href="{% url 'posts:delete_message' message.id %}" data-html2canvas-ignore="true">삭제</a>
                        {% else %}
                          <img src="{{ message.profile_img }}" alt="">
                          비공개 : 비밀 메시지입니다.
                        {% endif %}
                      {% endif %}
                    </li>                                 
                  {% endfor %}
                </ul>

              {% else %}
                {% if not birthday_page.state == "waiting"%}
                  <p>아직 메시지가 없습니다.</p>
                {% endif %}
              {% endif %}
              </div>
          {% endif %}
              


        </div>
      </div>
    </div>

    
    <!-- 페이지 링크 복사하기 버튼 -->
    {% if birthday_page.state != "archive" and birthday_page.state != "waiting" and is_owner %}
      <button class="floating-btn" onclick="clip();">
        <p class="floating-btn__text">페이지 링크 복사하기</p>
      </button>
    {% endif %}

    <!-- 축하 메시지 남기기 버튼-->
    {% if not is_owner %}
      {% if not birthday_page.state == "archive" %}
      <a class="floating-btn" href="{% url 'posts:create_message' year pk %}">
        <p class="floating-btn__text">축하 메시지 남기기</p>
      </a>
      {% endif %}
    {% endif %}

    {% if birthday_page.state == "upcoming" or birthday_page.state == "today" or birthday_page.state == "archive" or photo_page.state == "activate" or tmi_page.state == "activate"%}
    <div>
      <div><a href="{% url 'posts:detail_birthday_page' target_birth.year target_birth.owner.pk %}">축하메세지</a></div>
      <div><a href="{% url 'photos:photo_home' target_photo.year target_photo.photo_origin.pk %}">포토방명록</a></div>
      <div><a href="{% url 'tmies:detail_tmi_page' target_tmi.year target_tmi.tmi_origin.pk%}">내 친구의 TMI</a></div>
    </div>
    {% endif %}


    <script>
      //screenshot 기능
      function screenshot() {
        html2canvas(document.getElementById("screenshot")).then(function (canvas) {
          saveAs(canvas.toDataURL('image/jpg'), 'screenshotTest.jpg');
        })
      }

      function saveAs(uri, filename) {
        var link = document.createElement('a');
        if (typeof link.download === 'string') {
          link.href = uri;
          link.download = filename;
          document
            .body
            .appendChild(link);
          link.click();
          document
            .body
            .removeChild(link);
        } else {
          window.open(uir);
        }
      }

      const clip = () => {
        navigator.clipboard.writeText(window.location.href);
      }
    </script>

  </body>
{% endblock %}