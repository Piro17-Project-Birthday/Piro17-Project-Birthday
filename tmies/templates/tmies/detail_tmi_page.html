{% extends 'posts/base.html' %}
{% block title %}
  tmi ìŒ“ê¸°
{% endblock %}
{% block content %}
  {% load static%}

  <head>
    <link rel="stylesheet" href="{% static 'css/detail_tmipage.css' %}"/>
  </head>

  <body>
    {% if tmi_page.state == "deactivate" %}
      <div>
        ì•„ì§
        {{name}}
        ë‹˜ì˜
        {{year}}ë…„ ìƒì¼ í˜ì´ì§€ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ì–´ìš”!
      </div>
    {% elif tmi_page.state == "activate" or tmi_page.state == "archive" %}
      {% if tmi_page.state == "archive" %}
        <div>
          {{ name }}ë‹˜ì˜
          {{ year }}ë…„ TMI ìŒ“ê¸° í˜ì´ì§€ì…ë‹ˆë‹¤
        </div>
      {% else %}
        <div>
          {{ name }}ë‹˜ì— ëŒ€í•œ TMIëŠ” ë¬´ì—‡ì´ ìˆë‚˜ìš”?
        </div>
      {% endif %}

      {% if not is_owner %}
        {% if not tmi_page.state == "archive"%}
          <div>
            <button>
              <a href="{% url 'tmies:create_tmi_message' year pk %}">
                Tmi ë‚¨ê¸°ëŸ¬ ê°€ê¸°</a>
            </button>
          </div>
        {% endif %}
      {% endif %}
      {% if tmi_messages %}
        {% for tmi_message in tmi_messages%}
          <div class="message-id-{{ tmi_message.id }}">
            <div class="message_area">
              <div class="message_content">
                <p>
                  {{ tmi_message.content }}
                </p>
              </div>
              <div class="message_side">
                {% if is_owner or request.user == tmi_message.writer %}
                  {% if not tmi_page.state == "archive"%}
                    <span class="messaage_delete">
                      <a href="{% url 'tmies:delete_tmi_message' tmi_message.id %}">
                        <p class="delete_text">ì‚­ì œ</p>
                      </a>
                    </span>
                    <div class="like_area">
                      <button class="message_like_button" onclick="onClickLike({{ tmi_message.id }})">
                        ğŸ¤
                      </button>
                      <p class="message_like">
                        {{ tmi_message.like }}
                      </p>
                    </div>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div>
          ì•„ì§ ì‘ì„± ëœ Tmiê°€ ì—†ì–´ìš” ğŸ˜¢
        </div>
      {% endif %}
    {% endif %}

    {% if birthday_page.state == "upcoming" or birthday_page.state == "today" or birthday_page.state == "archive" or photo_page.state == "activate" or tmi_page.state == "activate"%}
      <footer>
        <div class="detail_page-footer">
          <a class="footer__birthdaypage" href="{% url 'posts:detail_birthday_page' target_birth.year target_birth.pk %}">ì¶•í•˜ë©”ì„¸ì§€</a>
          <a class="footer__photo" href="{% url 'photos:photo_home' target_photo.year target_photo.photo_origin.pk %}">í¬í† ë°©ëª…ë¡</a>
          <a class="footer__tmi" href="{% url 'tmies:detail_tmi_page' target_tmi.year target_tmi.tmi_origin.pk%}">ë‚´ ì¹œêµ¬ì˜ TMI</a>
        </div>
      </footer>
    {% endif %}

    <script>
      //tmi ë©”ì„¸ì§€ ë¦¬ìŠ¤íŠ¸ ì •ë ¬ìš©
      const colorTarget = document.getElementsByClassName("message_content")
      const fullTarget = document.getElementsByClassName("message_area")
      var colors = ['#A7DD71', '#EDADDA', '#FF8F87', '#FFDA96', '#93B8E1']

      for (i = 0; i < colorTarget.length; i++) {
        color = colors[i % 5]
        colorTarget[i].style.backgroundColor = color;
      }

      for (j = 0; j < fullTarget.length; j++) {
        if (j % 2 == 0) {
          fullTarget[j].style.marginLeft = '3.5rem';
        } else {
          fullTarget[j].style.marginLeft = '1rem'
          fullTarget[j].style.marginRight = '3.5rem'
        }
      }

      // ì¢‹ì•„ìš” ajax
      const strip = (string) => {
        return string.replace(/^\s+|\s+$/g, '');
      };

      const onClickLike = async (id) => {

        const url = "/like_ajax/"
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: JSON.stringify({id: id})
        });
        const {id: msgId} = await res.json();
        likeHandleResponse(msgId)
      }

      const likeHandleResponse = (id) => {
        const element = document.querySelector(`.message-id-${id} .message_like`);
        const num = element.innerHTML;
        const count = Number(num) + 1;

        element.innerHTML = `${count}`;
      }
    </script>
  </body>
{% endblock %}
