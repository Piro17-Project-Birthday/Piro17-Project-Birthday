{% extends 'posts/base.html' %}
{% block title %}
  tmi ìŒ“ê¸°
{% endblock %}
{% block content %}
  {% load static%}
  <head>
    <link rel="stylesheet" href="{% static 'css/detail_tmi_page.css' %}"/>
  </head>
  <body>
    <div class="content">
    {% if tmi_page.state == "deactivate" %}
      <div><span class="detail_tmi--name--sub">
        ì•„ì§
        {{name}}
        ë‹˜ì˜
        {{year}}ë…„ ìƒì¼ í˜ì´ì§€ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ì–´ìš”!</span>
      </div>
    {% elif tmi_page.state == "activate" or tmi_page.state == "archive" %}
      {% if tmi_page.state == "archive" %}
        <div>
          <span class="detail_tmi--name">{{ name }}</span>
          <span class="detail_tmi--name--sub">ë‹˜ì˜
          {{ year }}ë…„ ë‚´ ì¹œêµ¬ì˜ TMI í˜ì´ì§€ì…ë‹ˆë‹¤</span>
        </div>
      {% else %}
        
      <div class="text">
        <h1 class="text__title">ë‚´ ì¹œêµ¬ì˜ TMI</h1>
        <p class="text__description">
          {{name}}ë‹˜ì— ëŒ€í•œ TMIëŠ” ë¬´ì—‡ì´ ìˆë‚˜ìš”?
        </p>
      </div>
      {% endif %}

      {% if not is_owner %}
        {% if not tmi_page.state == "archive"%}
          <div>
              <a class= "floating-btn" id="login-btn">
                <div class="floating-btn__text">ë‚´ ì¹œêµ¬ì˜ TMI ë‚¨ê¸°ê¸°</div>
              </a>
          </div>
        {% endif %}
      {% endif %}
      {% if tmi_messages %}
        {% for tmi_message in tmi_messages%}
          <div class="message-id-{{ tmi_message.id }}">
            {{ tmi_message.content }}
            <button onclick="onClickLike({{ tmi_message.id }})">ğŸ‘ ì¶”ì²œ
            </button>
            <span class="message__like">
              {{ tmi_message.like }}
            </span>
            {% comment %} {% if is_owner or request.user == tmi_message.writer %}
              <span>
                <a href="{% url 'tmies:delete_tmi_message' tmi_message.id %}">ì‚­ì œ</a>
              </span>
            {% endif %} {% endcomment %}
            {% if is_owner or request.user == tmi_message.writer %}
              {% if not tmi_page.state == "archive"%}
                <span>
                  <a href="{% url 'tmies:delete_tmi_message' tmi_message.id %}">ì‚­ì œ</a>
                </span>
              {% endif %}
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="tmi-empty">
          ì•„ì§ ë‚¨ê²¨ì§„ TMIê°€ ì—†ì–´ìš”.
        </div>
      {% endif %}
    {% endif %}
      </div>
    {% if birthday_page.state == "upcoming" or birthday_page.state == "today" or birthday_page.state == "archive" or photo_page.state == "activate" or tmi_page.state == "activate"%}
    <div class="nav-bottom">
      <div class="nav-bottom__content">
        <a class="nav-bottom__content__birthdaypage" href="{% url 'posts:detail_birthday_page' target_birth.year target_birth.pk %}">ì¶•í•˜ë©”ì„¸ì§€</a>
        <a class="nav-bottom__content__photo" href="{% url 'photos:photo_home' target_photo.year target_photo.photo_origin.pk %}">í¬í† ë°©ëª…ë¡</a>
        <a class="nav-bottom__content__tmi" href="{% url 'tmies:detail_tmi_page' target_tmi.year target_tmi.tmi_origin.pk%}">ë‚´ ì¹œêµ¬ì˜ TMI</a>
      </div>
    </div>
    {% endif %}

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬-->
<div class="modal__login hidden">
  <div class="modal__login__overlay"></div>
  <div class="modal__login__content">
    <span class="modal__login__content__title">ë¡œê·¸ì¸ í•˜ì§€ ì•Šê³ <br/>ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì‹œê² ì–´ìš”?</span>
    <div class="modal__login__content__description">
      <h6>ë¡œê·¸ì¸ì„ í•˜ì§€ ì•Šìœ¼ë©´&nbsp</h6> 
      <div class="description__line">
        <h6>ë‚´ê°€ ë‚¨ê¸´&nbsp</h6>
        <h6>TMIë¥¼ &nbsp</h6>
      </div>
      <h6 class="bold">ì‚­ì œí•  ìˆ˜ ì—†ì–´ìš”.</h6>
    </div>
    <div class="modal__login__content__btns">
      <div class="login__social_login">
        <div class="login__yes">
          <a href="/login/?next={{ request.path }}" class="login__yes__text">ì†Œì…œ ë¡œê·¸ì¸ í•˜ëŸ¬ê°€ê¸°</a>
        </div>
        <div class="login__no" id="login__no">
          <a href="{% url 'tmies:create_tmi_message' year pk %}" class="login__no__text">ë¡œê·¸ì¸ ì—†ì´ ë‚¨ê¸°ê¸°</a>
        </div>
      </div>
      
    </div>
  </div>
</div>


    <script>
      const strip = (string) => {
        return string.replace(/^\s+|\s+$/g, '');
      };

      const onClickLike = async (id) => {

        const url = "/like_ajax/"
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: JSON.stringify({id: id})
        });
        const {id: msgId} = await res.json();
        likeHandleResponse(msgId)
      }

      const likeHandleResponse = (id) => {
        const element = document.querySelector(`.message-id-${id} .message__like`);
        const num = element.innerHTML;
        const count = Number(num) + 1;

        element.innerHTML = `${count}`;
      }

      //ë¡œê·¸ì¸ ëª¨ë‹¬
      const openButtonLogin = document.getElementById("login-btn");
      const modalLogin = document.querySelector(".modal__login");
      const closeButtonLogin = document.getElementById("login__no");

      const openModalLogin = () => {
        modalLogin.classList.remove("hidden");
      }
      const closeModalLogin = () => {
        modalLogin.classList.add("hidden");
      }
      
      openButtonLogin.addEventListener("click", openModalLogin);
      closeButtonLogin.addEventListener("click", closeModalLogin);

      const background_login = document.getElementsByClassName("modal__login__overlay")[0]
      background_login.onclick = function () {
        modalLogin.classList.add("hidden");
      }
    </script>
    
  </body>
{% endblock %}
